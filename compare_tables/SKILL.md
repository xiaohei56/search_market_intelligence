---
name: db_table_comparator
description: 数据库架构师技能，用于分析和比较两个表的字段结构差异。能够连接数据库获取表结构，分析字段映射关系，并生成包含颜色区分、迁移规则和图例说明的 Excel 对比文件。
---

## 【技能说明】

你是一位数据库架构师，负责分析和比较两个表的字段结构差异。根据用户提供的两个表名，查询数据库获取表结构，智能识别相同字段、差异字段及独有字段，并生成类似"用户表字段迁移对比.xlsx"格式的 Excel 对比文件，辅助数据迁移和结构同步。

---

## 【核心能力】

**⭐数据库结构获取：**
连接 MySQL 数据库，使用 SQL 命令（SHOW FULL COLUMNS）精准获取源表和目标表的完整字段定义。

**⭐智能字段映射分析：**
基于字段名相似度和注释进行匹配，识别相同字段（全匹配）、差异字段（类型不同）、源表独有及目标表独有字段。

**⭐迁移规则自动生成：**
为每对匹配字段生成迁移规则说明，自动标注需要类型转换或值转换的字段，并提供独有字段处理建议。

**⭐Excel 对比报告生成：**
使用 Python openpyxl 生成结构化 Excel 文件，利用绿/橙/黄/蓝四色区分字段状态，并自动附带图例与详细迁移说明。

---

## 【执行流程】

### 第一步：确认参数与环境

确认输入参数并准备数据库连接。

**数据库连接信息：**
- Host: 127.0.0.1
- Port: 3306
- User: root
- Password: 123456
- Database: qirui

**输入参数要求：**
- 格式：`/compare-tables 源表名 目标表名`
- 源表：显示在 Excel 左侧
- 目标表：显示在 Excel 右侧
- 输出目录：用户当前工作空间的 `docs/` 目录

---

### 第二步：获取表结构

分别查询源表和目标表的详细结构信息。

**执行命令：**
- 获取源表结构：
  ```bash
  mysql -h 127.0.0.1 -P 3306 -u root -p123456 qirui -e "SHOW FULL COLUMNS FROM {源表名};" 2>/dev/null
  ```
- 获取目标表结构：
  ```bash
  mysql -h 127.0.0.1 -P 3306 -u root -p123456 qirui -e "SHOW FULL COLUMNS FROM {目标表名};" 2>/dev/null
  ```

**自动生成：**
- 源表字段列表数据
- 目标表字段列表数据

---

### 第三步：分析映射与生成规则

分析字段间的差异并制定迁移策略。

**分析逻辑：**
- 根据字段名相似度和注释匹配字段
- 识别相同字段（字段名和类型完全相同）
- 识别差异字段（字段名相似但类型不同，或需要转换）
- 识别源表/目标表独有字段

**自动生成：**
- 字段映射关系表
- 迁移规则说明（类型转换、值转换、独有字段建议）

---

### 第四步：生成 Excel 对比文件

使用 Python openpyxl 库构建最终的对比报告。

**Excel 结构要求：**
- **第一行**：合并单元格显示表名标题（蓝色/绿色/紫色背景）
- **第二行**：列标题（源表字段名、数据类型、说明 | 目标表字段名、数据类型、说明 | 迁移规则）
- **数据行**：按映射关系排列，应用颜色区分：
  - 🟩 绿色：相同字段
  - 🟧 橙色：差异字段
  - 🟨 黄色：目标独有
  - 🟦 蓝色：源表独有
- **底部**：添加图例说明和迁移说明

**迁移说明模板：**
```text
图例说明:
■ 相同字段 (绿色)  ■ 差异字段 (橙色)  ■ 目标独有字段 (黄色)  ■ 源表独有字段 (蓝色)

迁移说明:
1. 源表表名：{源表名}
2. 目标表表名：{目标表名}
3. 主键字段差异：{描述}
4. 类型转换说明：{列出需要转换的字段}
5. 独有字段处理：{处理建议}
```

**自动生成：**
- Excel 文件：`{源表名}_{目标表名}_字段迁移对比.xlsx`
- 保存位置：`docs/` 目录（若不存在则自动创建）
- 注意：输出文件会覆盖同名文件

---

**示例调用：**
```
/compare-tables system_menu sys_menu
```
